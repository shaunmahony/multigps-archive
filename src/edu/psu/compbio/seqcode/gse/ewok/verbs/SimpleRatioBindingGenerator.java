package edu.psu.compbio.seqcode.gse.ewok.verbs;

import java.util.*;

import edu.psu.compbio.seqcode.gse.datasets.binding.BindingEvent;
import edu.psu.compbio.seqcode.gse.datasets.binding.BindingExtent;
import edu.psu.compbio.seqcode.gse.datasets.chipchip.ChipChipData;
import edu.psu.compbio.seqcode.gse.datasets.general.Region;
import edu.psu.compbio.seqcode.gse.ewok.*;
import edu.psu.compbio.seqcode.gse.ewok.nouns.*;
import edu.psu.compbio.seqcode.gse.utils.*;

/**
 * @author tdanford
 *
 */
public class SimpleRatioBindingGenerator<RegionType extends Region> implements Expander<RegionType,BindingEvent>{
	
    private ChipChipData data;
    private double thresh;
    private int maxExtend;
    private String type;

    public SimpleRatioBindingGenerator(ChipChipData data, double thresh1) { 
        this.data = data;
        this.thresh = thresh1;
        maxExtend = 1000;
        type = data.getName();
    }
    
    public Iterator<BindingEvent> execute(RegionType r) {
    	LinkedList<BindingEvent> extents = new LinkedList<BindingEvent>();
    	try {
			data.window(r.getChrom(), r.getStart(), r.getEnd());
			
			int start = -1;
			int ppos = -1;
			double maxRatio = 0.0;
			double meanRatio = 0.0;
			int probeCount = 0;
			int pos = -1;
			
			for(int i = 0; i < data.getCount(); i++) { 
				double ratio = getMeanRatio(i);
				pos = data.getPos(i);
				
				if(ratio >= thresh) { 
					if(ppos == -1) {
						maxRatio = ratio;
						meanRatio = ratio;
						probeCount = 1;
						if(i == 0) { 
							ppos = pos - maxExtend;
						} else { 
							int prevPosition = data.getPos(i-1);
							ppos = Math.max(prevPosition, pos-maxExtend);
						}
					} else { 
						maxRatio = Math.max(maxRatio, ratio);
						probeCount += 1;
						meanRatio += ratio;
					}
				} else { 
					if(ppos != -1) {
						meanRatio /= (double)probeCount;
						int end = pos + maxExtend;
						if(i < data.getCount()-1) {  
							end = Math.min(end, data.getPos(i+1));
						}
						BindingEvent ext = new BindingEvent(r.getGenome(), r.getChrom(), ppos, end, maxRatio, meanRatio, type);
						extents.add(ext);
					}
				}
			}
			
			if(ppos != -1) {
				meanRatio /= (double)probeCount;
				int end = pos + maxExtend;
				BindingEvent ext = new BindingEvent(r.getGenome(), r.getChrom(), ppos, end, maxRatio, meanRatio, type);
				extents.add(ext);
			}
			
		} catch (NotFoundException e) {
			e.printStackTrace();
		}
		return extents.iterator();
    }
    
    private double getMeanRatio(int idx) { 
    	double sum = 0.0;
    	int count = data.getReplicates(idx);
    	
    	for(int j = 0; j < count; j++) { 
    		sum += data.getRatio(idx, j);
    	}
  
    	return sum / (double)count;
    }

}
